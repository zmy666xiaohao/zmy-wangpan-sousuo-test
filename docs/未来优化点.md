# PanHub é¡¹ç›®ä¼˜åŒ–å»ºè®®æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š2026-01-06
> åˆ†æèŒƒå›´ï¼šå®Œæ•´é¡¹ç›®ä»£ç å®¡æŸ¥

---

## ğŸ“‹ ç›®å½•
- [æ¶æ„ä¼˜åŒ–](#æ¶æ„ä¼˜åŒ–)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨æ€§å¢å¼º](#å®‰å…¨æ€§å¢å¼º)
- [ä»£ç è´¨é‡](#ä»£ç è´¨é‡)
- [å¯ç»´æŠ¤æ€§](#å¯ç»´æŠ¤æ€§)
- [éƒ¨ç½²ä¼˜åŒ–](#éƒ¨ç½²ä¼˜åŒ–)
- [ç«‹å³è¡ŒåŠ¨é¡¹](#ç«‹å³è¡ŒåŠ¨é¡¹)
- [å¿«é€Ÿæ”¶ç›Šä¼˜åŒ–](#å¿«é€Ÿæ”¶ç›Šä¼˜åŒ–)

---

## ğŸ—ï¸ æ¶æ„ä¼˜åŒ–

### 1. æ’ä»¶ç³»ç»Ÿæ”¹è¿›

**é—®é¢˜**: æ’ä»¶æ³¨å†Œæœºåˆ¶å­˜åœ¨å†—ä½™ï¼Œå…¨å±€æ³¨å†Œè¡¨å’Œ PluginManager é‡å¤

**ä½ç½®**: `server/core/plugins/manager.ts:54-80`

**å»ºè®®**:
```typescript
// å½“å‰é—®é¢˜ä»£ç 
const globalRegistry = new Map<string, AsyncSearchPlugin>(); // å†—ä½™
export function registerGlobalPlugin(plugin: AsyncSearchPlugin) { /* ... */ }

// å»ºè®®æ”¹è¿›
export class PluginManager {
  private plugins = new Map<string, AsyncSearchPlugin>();

  register(plugin: AsyncSearchPlugin) {
    this.plugins.set(plugin.name(), plugin);
  }

  get(name: string) {
    return this.plugins.get(name);
  }
}
```

**æ”¶ç›Š**:
- å‡å°‘ä¸€å±‚æŠ½è±¡ï¼Œé™ä½å¤æ‚åº¦
- é¿å…å…¨å±€çŠ¶æ€æ±¡æŸ“
- æ›´å®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•

**å®æ–½æ­¥éª¤**:
1. ç§»é™¤ `globalRegistry` å’Œç›¸å…³å‡½æ•°
2. ä¿®æ”¹ `services/index.ts` ç›´æ¥ä½¿ç”¨ PluginManager
3. æ›´æ–°æ‰€æœ‰æ’ä»¶çš„æ³¨å†Œæ–¹å¼

---

### 2. æœåŠ¡å±‚è§£è€¦

**é—®é¢˜**: `SearchService` æ‰¿æ‹…è¿‡å¤šèŒè´£

**ä½ç½®**: `server/core/services/searchService.ts`

**å½“å‰èŒè´£**:
- Telegram é¢‘é“æœç´¢
- æ’ä»¶æœç´¢
- å†…å­˜ç¼“å­˜ç®¡ç†
- ç»“æœåˆå¹¶
- ç»“æœæ’åº
- å¹¶å‘æ§åˆ¶

**å»ºè®®æ‹†åˆ†**:
```typescript
// server/core/services/
â”œâ”€â”€ tg-search.service.ts       // Telegram æœç´¢ä¸“ç”¨
â”œâ”€â”€ plugin-search.service.ts   // æ’ä»¶æœç´¢ä¸“ç”¨
â”œâ”€â”€ cache.service.ts           // ç»Ÿä¸€ç¼“å­˜ç®¡ç†
â”œâ”€â”€ result-merger.service.ts   // ç»“æœåˆå¹¶ä¸å»é‡
â””â”€â”€ search-coordinator.ts      // åè°ƒå„æœåŠ¡
```

**æ”¶ç›Š**:
- å•ä¸€èŒè´£åŸåˆ™
- æ›´å®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤
- ä¾¿äºç‹¬ç«‹æ‰©å±•

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 3. å†…å­˜ç¼“å­˜ä¼˜åŒ–

**é—®é¢˜**: LRU å®ç°å¤æ‚ä¸”æœ‰æ€§èƒ½å¼€é”€

**ä½ç½®**: `server/core/cache/memoryCache.ts`

**å½“å‰é—®é¢˜**:
```typescript
// æ¯æ¬¡ get/set éƒ½è¦ç»´æŠ¤ accessOrder
private accessOrder = new Map<string, number>();
private sequence = 0;

// æ¯æ¬¡è®¿é—®éƒ½è¦æ’åº
get(key: string) {
  // ...
  this.sequence++;
  this.accessOrder.set(key, this.sequence);
}
```

**å»ºè®®æ”¹è¿›**:
```typescript
export class MemoryCache<T = unknown> {
  private store = new Map<string, CacheRecord<T>>();
  private maxSize: number;
  private maxMemoryBytes: number;

  get(key: string): { hit: boolean; value?: T } {
    const record = this.store.get(key);
    if (!record || record.expireAt <= Date.now()) {
      this.store.delete(key);
      return { hit: false };
    }

    // ç§»åŠ¨åˆ°æœ«å°¾ï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰- O(1)
    this.store.delete(key);
    this.store.set(key, record);

    return { hit: true, value: record.value };
  }

  set(key: string, value: T, ttlMs: number): void {
    // æ£€æŸ¥å®¹é‡
    if (this.store.size >= this.maxSize) {
      // åˆ é™¤æœ€æ—§çš„ï¼ˆMap ä¿æŒæ’å…¥é¡ºåºï¼‰
      const firstKey = this.store.keys().next().value;
      this.store.delete(firstKey);
    }

    const size = this.estimateSize(value);
    const record: CacheRecord<T> = {
      value,
      expireAt: Date.now() + ttlMs,
      size,
    };

    this.store.set(key, record);
  }
}
```

**æ”¶ç›Š**:
- ä»£ç è¡Œæ•°å‡å°‘ 60%
- æ€§èƒ½æå‡ï¼ˆé¿å…é¢‘ç¹æ’åºï¼‰
- æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤

---

### 4. å¹¶å‘æ§åˆ¶ä¼˜åŒ–

**é—®é¢˜**: ç¼ºä¹åŠ¨æ€è°ƒæ•´å’Œä¼˜å…ˆçº§é˜Ÿåˆ—

**ä½ç½®**: `server/core/services/searchService.ts:406-413`

**å»ºè®®**:
```typescript
// åŠ¨æ€å¹¶å‘è°ƒæ•´
class AdaptiveConcurrency {
  private baseConcurrency: number;
  private slowResponseCount = 0;

  getConcurrency(): number {
    // å¦‚æœæœ€è¿‘å“åº”æ…¢ï¼Œé™ä½å¹¶å‘
    if (this.slowResponseCount > 3) {
      return Math.max(1, this.baseConcurrency - 1);
    }
    return this.baseConcurrency;
  }

  recordResponseTime(ms: number) {
    if (ms > 3000) this.slowResponseCount++;
    else this.slowResponseCount = Math.max(0, this.slowResponseCount - 1);
  }
}

// ä¼˜å…ˆçº§é˜Ÿåˆ—
interface SearchTask {
  channel: string;
  priority: number; // 1-5, 1=æœ€é«˜
  weight: number;   // æƒé‡
}

// æŒ‰ä¼˜å…ˆçº§æ’åºåæ‰§è¡Œ
const prioritized = tasks.sort((a, b) => a.priority - b.priority);
```

**æ”¶ç›Š**:
- è‡ªé€‚åº”ç³»ç»Ÿè´Ÿè½½
- ä¼˜å…ˆé¢‘é“æ›´å¿«å“åº”
- é¿å…èµ„æºè€—å°½

---

### 5. å‰ç«¯æœç´¢æµç¨‹ä¼˜åŒ–

**é—®é¢˜**: `useSearch.ts` æ–‡ä»¶è¿‡å¤§ï¼ˆ10KBï¼‰ï¼ŒèŒè´£ä¸æ¸…

**ä½ç½®**: `composables/useSearch.ts`

**å»ºè®®æ‹†åˆ†**:
```typescript
// composables/useSearch/
â”œâ”€â”€ index.ts              // ä¸»å…¥å£ï¼Œç»„åˆæ‰€æœ‰åŠŸèƒ½
â”œâ”€â”€ state.ts              // çŠ¶æ€ç®¡ç†
â”œâ”€â”€ flow.ts               // æœç´¢æµç¨‹æ§åˆ¶
â”œâ”€â”€ batch.ts              // æ‰¹æ¬¡å¤„ç†é€»è¾‘
â””â”€â”€ utils.ts              // å·¥å…·å‡½æ•°

// state.ts
export function useSearchState() {
  const state = ref<SearchState>({ /* ... */ });
  return { state };
}

// flow.ts
export function useSearchFlow(state) {
  const performFastSearch = async () => { /* ... */ };
  const performDeepSearch = async () => { /* ... */ };
  return { performFastSearch, performDeepSearch };
}

// index.ts
export function useSearch() {
  const { state } = useSearchState();
  const { performFastSearch, performDeepSearch } = useSearchFlow(state);
  // ...
}
```

**æ”¶ç›Š**:
- æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
- ä¾¿äºæµ‹è¯•å’Œå¤ç”¨
- ä»£ç å¯è¯»æ€§æå‡

---

## ğŸ”’ å®‰å…¨æ€§å¢å¼º

### 6. è¾“å…¥éªŒè¯ä¸æ¸…ç†

**é—®é¢˜**: æœç´¢è¯å’Œå‚æ•°ç¼ºä¹ä¸¥æ ¼éªŒè¯

**ä½ç½®**: `server/api/search.get.ts:19-44`

**å½“å‰ä»£ç **:
```typescript
const kw = ((q.kw as string) || "").trim();
if (!kw) {
  return sendError(event, createError({ statusCode: 400, statusMessage: "kw is required" }));
}
```

**å»ºè®®æ”¹è¿›**:
```typescript
import { z } from 'zod';

const searchSchema = z.object({
  kw: z.string()
    .trim()
    .min(1, 'æœç´¢è¯ä¸èƒ½ä¸ºç©º')
    .max(100, 'æœç´¢è¯è¿‡é•¿ï¼ˆæœ€å¤§100å­—ç¬¦ï¼‰')
    .regex(/^[a-zA-Z0-9\u4e00-\u9fa5\s]+$/, 'æœç´¢è¯åŒ…å«éæ³•å­—ç¬¦'),

  conc: z.number()
    .int()
    .min(1, 'å¹¶å‘æ•°è‡³å°‘ä¸º1')
    .max(20, 'å¹¶å‘æ•°ä¸èƒ½è¶…è¿‡20')
    .default(4),

  channels: z.array(z.string())
    .max(50, 'æœ€å¤šé€‰æ‹©50ä¸ªé¢‘é“')
    .optional(),

  refresh: z.boolean().optional(),

  res: z.enum(['merged_by_type', 'results', 'all']).default('merged_by_type'),

  src: z.enum(['all', 'tg', 'plugin']).default('all'),

  plugins: z.array(z.string()).max(20).optional(),

  cloud_types: z.array(z.string()).max(10).optional(),

  ext: z.string().optional().refine(
    (val) => !val || (() => { try { JSON.parse(val); return true; } catch { return false; } })(),
    'ext å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON'
  ),
});

export default defineEventHandler(async (event) => {
  const query = getQuery(event);

  // éªŒè¯å¹¶è½¬æ¢
  const result = searchSchema.safeParse({
    kw: query.kw,
    conc: query.conc ? Number(query.conc) : undefined,
    channels: query.channels?.split(',').filter(Boolean),
    refresh: query.refresh === 'true',
    res: query.res,
    src: query.src,
    plugins: query.plugins?.split(',').filter(Boolean),
    cloud_types: query.cloud_types?.split(',').filter(Boolean),
    ext: query.ext,
  });

  if (!result.success) {
    return sendError(
      event,
      createError({
        statusCode: 400,
        statusMessage: 'å‚æ•°éªŒè¯å¤±è´¥',
        data: result.error.errors,
      })
    );
  }

  const req = result.data;
  // ... ç»§ç»­å¤„ç†
});
```

**æ”¶ç›Š**:
- é˜²æ­¢æ¶æ„è¾“å…¥
- æ¸…æ™°çš„é”™è¯¯æç¤º
- ç±»å‹å®‰å…¨

---

### 7. SQL æ³¨å…¥é˜²æŠ¤

**é—®é¢˜**: å†…å­˜é™çº§æ¨¡å¼ç¼ºä¹è¾“å…¥éªŒè¯

**ä½ç½®**: `server/core/services/hotSearchSQLite.ts`

**å»ºè®®**:
```typescript
// æ‰€æœ‰è¾“å…¥å¿…é¡»éªŒè¯
async recordSearch(term: string): Promise<void> {
  // 1. é•¿åº¦éªŒè¯
  if (!term || term.length < 1 || term.length > 100) return;

  // 2. å­—ç¬¦éªŒè¯
  if (!/^[a-zA-Z0-9\u4e00-\u9fa5\s]+$/.test(term)) return;

  // 3. è¿è§„è¯æ£€æŸ¥
  if (await this.isForbidden(term)) {
    console.log(`[HotSearchSQLite] è¿è§„è¯è¢«è¿‡æ»¤: ${term}`);
    return;
  }

  // 4. å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå·²å­˜åœ¨ï¼Œä½†éœ€ç¡®ä¿ï¼‰
  const stmt = this.db.prepare(`
    INSERT INTO hot_searches (term, score, last_searched, created_at)
    VALUES (?, 1, ?, ?)
    ON CONFLICT(term) DO UPDATE SET
      score = score + 1,
      last_searched = ?
  `);

  stmt.run(term, now, now, now);
}

// å†…å­˜æ¨¡å¼ä¹Ÿéœ€éªŒè¯
private initMemoryFallback() {
  // ...
  prepare(sql: string) {
    // å¯¹æ‰€æœ‰è¾“å…¥è¿›è¡Œæ¸…ç†
    const sanitize = (input: string) => {
      return input.replace(/[<>\"']/g, '');
    };
    // ...
  }
}
```

**æ”¶ç›Š**:
- é˜²æ­¢ SQL æ³¨å…¥
- å†…å­˜æ¨¡å¼åŒæ ·å®‰å…¨
- æ•°æ®å®Œæ•´æ€§ä¿è¯

---

### 8. é€Ÿç‡é™åˆ¶

**é—®é¢˜**: æ—  API è°ƒç”¨é¢‘ç‡é™åˆ¶

**å»ºè®®å®ç°**:
```typescript
// server/middleware/rate-limit.ts
import { createStorage } from 'unstorage';
import memoryDriver from 'unstorage/drivers/memory';

interface RateLimitConfig {
  windowMs: number;
  maxRequests: number;
}

const storage = createStorage({ driver: memoryDriver() });

export async function checkRateLimit(
  identifier: string,
  config: RateLimitConfig = { windowMs: 60000, maxRequests: 60 }
): Promise<{ allowed: boolean; remaining: number; resetAt: number }> {
  const key = `rate:${identifier}`;
  const now = Date.now();

  const record = await storage.getItem<{
    count: number;
    resetAt: number;
  }>(key);

  // æ–°çª—å£
  if (!record || now > record.resetAt) {
    await storage.setItem(key, {
      count: 1,
      resetAt: now + config.windowMs,
    });
    return { allowed: true, remaining: config.maxRequests - 1, resetAt: now + config.windowMs };
  }

  // è¶…å‡ºé™åˆ¶
  if (record.count >= config.maxRequests) {
    return {
      allowed: false,
      remaining: 0,
      resetAt: record.resetAt,
    };
  }

  // å¢åŠ è®¡æ•°
  record.count++;
  await storage.setItem(key, record);

  return {
    allowed: true,
    remaining: config.maxRequests - record.count,
    resetAt: record.resetAt,
  };
}

// server/api/search.get.ts
export default defineEventHandler(async (event) => {
  const ip = getHeader(event, 'x-forwarded-for') || getRequestIP(event);
  const rateLimit = await checkRateLimit(ip, {
    windowMs: 60000,
    maxRequests: 100, // æ¯åˆ†é’Ÿ 100 æ¬¡
  });

  if (!rateLimit.allowed) {
    setResponseHeader(event, 'X-RateLimit-Reset', rateLimit.resetAt.toString());
    return sendError(
      event,
      createError({
        statusCode: 429,
        statusMessage: 'è¯·æ±‚è¿‡äºé¢‘ç¹',
        data: {
          retryAfter: Math.ceil((rateLimit.resetAt - Date.now()) / 1000),
        },
      })
    );
  }

  // æ­£å¸¸å¤„ç†...
});
```

**æ”¶ç›Š**:
- é˜²æ­¢ API æ»¥ç”¨
- ä¿æŠ¤åç«¯èµ„æº
- æä¾›æ¸…æ™°çš„é™æµä¿¡æ¯

---

## ğŸ› ï¸ ä»£ç è´¨é‡

### 9. é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–

**é—®é¢˜**: é”™è¯¯å¤„ç†åˆ†æ•£ï¼Œæ—¥å¿—ä¸ä¸€è‡´

**ä½ç½®**: å¤šå¤„

**å»ºè®®**:
```typescript
// server/core/errors/app-error.ts
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 500,
    public details?: any,
    public shouldLog: boolean = true
  ) {
    super(message);
    this.name = 'AppError';
  }

  static badRequest(code: string, message: string, details?: any) {
    return new AppError(code, message, 400, details);
  }

  static unauthorized(code: string, message: string) {
    return new AppError(code, message, 401);
  }

  static notFound(code: string, message: string) {
    return new AppError(code, message, 404);
  }

  static internal(code: string, message: string, details?: any) {
    return new AppError(code, message, 500, details, true);
  }
}

// server/core/utils/error-handler.ts
import { logger } from './logger';

export function handleError(error: unknown): AppError {
  // å·²çŸ¥é”™è¯¯
  if (error instanceof AppError) {
    if (error.shouldLog) {
      logger.error(error.message, {
        code: error.code,
        details: error.details,
        stack: error.stack,
      });
    }
    return error;
  }

  // æœªçŸ¥é”™è¯¯
  if (error instanceof Error) {
    logger.error('Unexpected error', {
      message: error.message,
      stack: error.stack,
    });
    return AppError.internal('UNEXPECTED_ERROR', 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
  }

  // å…¶ä»–ç±»å‹
  logger.error('Unknown error type', { error });
  return AppError.internal('UNKNOWN_ERROR', 'æœªçŸ¥é”™è¯¯');
}

// ä½¿ç”¨ç¤ºä¾‹
export default defineEventHandler(async (event) => {
  try {
    // ä¸šåŠ¡é€»è¾‘
    const result = await performSearch();
    return { code: 0, data: result };
  } catch (error) {
    const appError = handleError(error);
    return sendError(event, createError({
      statusCode: appError.statusCode,
      statusMessage: appError.message,
      data: {
        code: appError.code,
        details: appError.details,
      },
    }));
  }
});
```

**æ”¶ç›Š**:
- ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—
- æ›´å¥½çš„è°ƒè¯•ä½“éªŒ

---

### 10. ç±»å‹å®‰å…¨å¢å¼º

**é—®é¢˜**: å¤§é‡ `any` ç±»å‹å’Œç±»å‹æ–­è¨€

**ä½ç½®**: å¤šå¤„

**ç¤ºä¾‹**:
```typescript
// å½“å‰
const requestedTimeout = Number((ext as any)?.__plugin_timeout_ms) || 0;

// å»ºè®®
interface SearchExtension {
  __plugin_timeout_ms?: number;
  [key: string]: unknown;
}

const extSchema = z.object({
  __plugin_timeout_ms: z.number().optional(),
}).catchall(z.unknown());

const parsed = extSchema.safeParse(ext);
if (parsed.success) {
  const requestedTimeout = parsed.data.__plugin_timeout_ms || 0;
}
```

**å®Œæ•´ç±»å‹ä½“ç³»**:
```typescript
// server/core/types/search.ts
import { z } from 'zod';

// æœç´¢è¯·æ±‚éªŒè¯
export const SearchRequestSchema = z.object({
  kw: z.string().trim().min(1).max(100),
  channels: z.array(z.string()).optional(),
  conc: z.number().int().min(1).max(20).optional(),
  refresh: z.boolean().optional(),
  res: z.enum(['merged_by_type', 'results', 'all']).default('merged_by_type'),
  src: z.enum(['all', 'tg', 'plugin']).default('all'),
  plugins: z.array(z.string()).optional(),
  cloud_types: z.array(z.string()).optional(),
  ext: z.record(z.unknown()).optional(),
});

export type SearchRequest = z.infer<typeof SearchRequestSchema>;

// æœç´¢ç»“æœç±»å‹
export interface SearchResult {
  message_id: string;
  unique_id: string;
  channel: string;
  datetime: string;
  title: string;
  content: string;
  links: Array<{
    type: string;
    url: string;
    password: string;
  }>;
}

export interface SearchResponse {
  total: number;
  results?: SearchResult[];
  merged_by_type?: MergedLinks;
}

// æ’ä»¶ç±»å‹
export interface AsyncSearchPlugin {
  name(): string;
  priority(): number;
  search(keyword: string, ext?: Record<string, unknown>): Promise<SearchResult[]>;
  setMainCacheKey(key: string): void;
  setCurrentKeyword(keyword: string): void;
  skipServiceFilter(): boolean;
}
```

**æ”¶ç›Š**:
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- IDE æ™ºèƒ½æç¤º
- å‡å°‘è¿è¡Œæ—¶é”™è¯¯

---

### 11. å¸¸é‡ç®¡ç†

**é—®é¢˜**: é­”æ•°å’Œç¡¬ç¼–ç åˆ†æ•£

**ä½ç½®**: å¤šå¤„

**å»ºè®®**:
```typescript
// config/constants.ts

// æœç´¢é…ç½®
export const SEARCH_CONFIG = {
  PER_CHANNEL_LIMIT: 30,
  DEFAULT_CONCURRENCY: 4,
  MIN_CONCURRENCY: 1,
  MAX_CONCURRENCY: 20,
  BATCH_SIZE: 4,
  TIMEOUT_MS: 5000,
  MIN_TIMEOUT_MS: 3000,
  MAX_TIMEOUT_MS: 30000,
} as const;

// ç¼“å­˜é…ç½®
export const CACHE_CONFIG = {
  DEFAULT_MAX_SIZE: 1000,
  DEFAULT_MAX_MEMORY_MB: 100,
  DEFAULT_TTL_MINUTES: 30,
  CLEANUP_INTERVAL_MS: 5 * 60 * 1000,
  MEMORY_THRESHOLD: 0.8, // 80% è§¦å‘æ¸…ç†
} as const;

// æ’ä»¶é…ç½®
export const PLUGIN_CONFIG = {
  DEFAULT_PRIORITY: 3,
  MAX_RETRIES: 3,
  BASE_DELAY_MS: 1000,
  TIMEOUT_MS: 5000,
} as const;

// çƒ­æœé…ç½®
export const HOT_SEARCH_CONFIG = {
  MAX_ENTRIES: 30,
  DB_PATH: './data/hot-searches.db',
  DB_DIR: './data',
} as const;

// API é…ç½®
export const API_CONFIG = {
  RATE_LIMIT_WINDOW_MS: 60000,
  RATE_LIMIT_MAX_REQUESTS: 100,
  SEARCH_RESULT_LIMIT: 100,
} as const;

// ä½¿ç”¨ç¤ºä¾‹
import { SEARCH_CONFIG, CACHE_CONFIG } from '~/config/constants';

class SearchService {
  private timeoutMs = SEARCH_CONFIG.TIMEOUT_MS;
  private concurrency = SEARCH_CONFIG.DEFAULT_CONCURRENCY;

  private cache = new MemoryCache({
    maxSize: CACHE_CONFIG.DEFAULT_MAX_SIZE,
    ttlMinutes: CACHE_CONFIG.DEFAULT_TTL_MINUTES,
  });
}
```

**æ”¶ç›Š**:
- é…ç½®é›†ä¸­ç®¡ç†
- é¿å…é­”æ³•æ•°å­—
- ä¾¿äºè°ƒæ•´å’Œæ–‡æ¡£åŒ–

---

## ğŸ“Š å¯ç»´æŠ¤æ€§

### 12. é…ç½®é›†ä¸­åŒ–

**é—®é¢˜**: é…ç½®åˆ†æ•£åœ¨å¤šå¤„

**å»ºè®®**:
```typescript
// config/index.ts
import channelsConfig from './channels.json';
import { SEARCH_CONFIG, CACHE_CONFIG, PLUGIN_CONFIG } from './constants';

export const AppConfig = {
  // æœç´¢é…ç½®
  search: {
    defaultConcurrency: SEARCH_CONFIG.DEFAULT_CONCURRENCY,
    timeoutMs: SEARCH_CONFIG.TIMEOUT_MS,
    maxRetries: PLUGIN_CONFIG.MAX_RETRIES,
  },

  // Telegram é…ç½®
  tg: {
    priorityChannels: channelsConfig.priorityChannels,
    defaultChannels: channelsConfig.defaultChannels,
    perChannelLimit: SEARCH_CONFIG.PER_CHANNEL_LIMIT,
  },

  // æ’ä»¶é…ç½®
  plugins: {
    defaultPlugins: channelsConfig.defaultPlugins,
    timeoutMs: channelsConfig.pluginTimeoutMs,
    defaultPriority: PLUGIN_CONFIG.DEFAULT_PRIORITY,
  },

  // ç¼“å­˜é…ç½®
  cache: {
    enabled: true,
    ttlMinutes: channelsConfig.cacheTtlMinutes,
    maxSize: CACHE_CONFIG.DEFAULT_MAX_SIZE,
    maxMemoryMB: CACHE_CONFIG.DEFAULT_MAX_MEMORY_MB,
  },

  // API é…ç½®
  api: {
    rateLimit: {
      windowMs: API_CONFIG.RATE_LIMIT_WINDOW_MS,
      maxRequests: API_CONFIG.RATE_LIMIT_MAX_REQUESTS,
    },
    resultLimit: API_CONFIG.SEARCH_RESULT_LIMIT,
  },

  // ç¯å¢ƒé…ç½®
  env: {
    isProduction: process.env.NODE_ENV === 'production',
    isDevelopment: process.env.NODE_ENV === 'development',
    logLevel: process.env.LOG_LEVEL || 'info',
  },
};

// server/runtime-config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    // Server-only
    ...AppConfig,
    // Public
    public: {
      apiBase: '/api',
      siteUrl: process.env.SITE_URL || 'https://panhub.shenzjd.com',
      tgDefaultChannels: AppConfig.tg.defaultChannels,
    },
  },
});
```

**æ”¶ç›Š**:
- ä¸€å¤„ä¿®æ”¹ï¼Œå…¨å±€ç”Ÿæ•ˆ
- é…ç½®æ–‡æ¡£åŒ–
- ç¯å¢ƒéš”ç¦»æ¸…æ™°

---

### 13. æµ‹è¯•è¦†ç›–æå‡

**é—®é¢˜**: æµ‹è¯•è¦†ç›–ç‡ä¸è¶³

**å»ºè®®ç»“æ„**:
```
test/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ search-service.test.ts
â”‚   â”‚   â”œâ”€â”€ hot-search-sqlite.test.ts
â”‚   â”‚   â””â”€â”€ cache-service.test.ts
â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â”œâ”€â”€ pansearch.test.ts
â”‚   â”‚   â”œâ”€â”€ thepiratebay.test.ts
â”‚   â”‚   â””â”€â”€ manager.test.ts
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ fetch.test.ts
â”‚       â”œâ”€â”€ logger.test.ts
â”‚       â””â”€â”€ error-handler.test.ts
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ search.test.ts
â”‚   â”‚   â””â”€â”€ hot-searches.test.ts
â”‚   â””â”€â”€ flow/
â”‚       â””â”€â”€ search-flow.test.ts
â””â”€â”€ performance/
    â”œâ”€â”€ cache-benchmark.test.ts
    â””â”€â”€ concurrency.test.ts
```

**ç¤ºä¾‹æµ‹è¯•**:
```typescript
// test/unit/plugins/pansearch.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { PansearchPlugin } from '~/server/core/plugins/pansearch';
import { fetchWithRetry } from '~/server/core/utils/fetch';

vi.mock('~/server/core/utils/fetch');

describe('PansearchPlugin', () => {
  let plugin: PansearchPlugin;

  beforeEach(() => {
    plugin = new PansearchPlugin();
    vi.clearAllMocks();
  });

  it('should have correct name and priority', () => {
    expect(plugin.name()).toBe('pansearch');
    expect(plugin.priority()).toBe(3);
  });

  it('should parse search results correctly', async () => {
    const mockResponse = {
      pageProps: {
        data: {
          data: [
            {
              id: 1,
              content: 'åç§°ï¼šæµ‹è¯•ç”µå½±<br><a href="https://pan.baidu.com/s/123">é“¾æ¥</a>',
              pan: 'baidu',
              time: '2024-01-01',
            },
          ],
        },
      },
    };

    vi.mocked(fetchWithRetry).mockResolvedValueOnce(mockResponse);
    vi.mocked(fetchWithRetry).mockResolvedValueOnce('<script id="__NEXT_DATA__">{"buildId":"test123"}</script>');

    const results = await plugin.search('æµ‹è¯•');

    expect(results).toHaveLength(1);
    expect(results[0].title).toBe('æµ‹è¯•ç”µå½±');
    expect(results[0].links[0].type).toBe('baidu');
  });

  it('should handle network errors gracefully', async () => {
    vi.mocked(fetchWithRetry).mockRejectedValueOnce(new Error('Network error'));

    const results = await plugin.search('æµ‹è¯•');
    expect(results).toEqual([]);
  });

  it('should handle empty results', async () => {
    vi.mocked(fetchWithRetry).mockResolvedValueOnce({
      pageProps: { data: { data: [] } },
    });
    vi.mocked(fetchWithRetry).mockResolvedValueOnce('<script id="__NEXT_DATA__">{"buildId":"test123"}</script>');

    const results = await plugin.search('æ— ç»“æœ');
    expect(results).toEqual([]);
  });
});

// test/integration/api/search.test.ts
import { describe, it, expect, beforeAll } from 'vitest';
import { createApp, toNodeListener } from 'h3';
import { createRouter } from 'router';
import { searchHandler } from '~/server/api/search.get';

describe('Search API Integration', () => {
  let app: ReturnType<typeof createApp>;

  beforeAll(() => {
    app = createApp();
    const router = createRouter();
    router.get('/api/search', searchHandler);
    app.use(router);
  });

  it('should return valid search results', async () => {
    const server = createServer(toNodeListener(app));
    const port = await getFreePort();
    server.listen(port);

    const response = await fetch(`http://localhost:${port}/api/search?kw=æµ‹è¯•&conc=2`);
    const data = await response.json();

    expect(data.code).toBe(0);
    expect(data.data).toHaveProperty('total');
    expect(Array.isArray(data.data.merged_by_type)).toBe(true);

    server.close();
  });

  it('should reject invalid parameters', async () => {
    const server = createServer(toNodeListener(app));
    const port = await getFreePort();
    server.listen(port);

    // ç©ºæœç´¢è¯
    const response1 = await fetch(`http://localhost:${port}/api/search?kw=`);
    expect(response1.status).toBe(400);

    // å¹¶å‘æ•°è¿‡å¤§
    const response2 = await fetch(`http://localhost:${port}/api/search?kw=æµ‹è¯•&conc=100`);
    expect(response2.status).toBe(400);

    server.close();
  });
});
```

**æ”¶ç›Š**:
- ä»£ç è´¨é‡ä¿è¯
- é‡æ„ä¿¡å¿ƒ
- æ–‡æ¡£åŒ–è¡Œä¸º

---

### 14. æ—¥å¿—å’Œç›‘æ§

**é—®é¢˜**: æ—¥å¿—ä¸»è¦ç”¨äºè°ƒè¯•ï¼Œç¼ºä¹ç”Ÿäº§çº§ç›‘æ§

**å»ºè®®**:
```typescript
// server/core/utils/metrics.ts
export interface SearchMetrics {
  totalRequests: number;
  successfulRequests: number;
  failedRequests: number;
  averageResponseTime: number;
  cacheHitRate: number;
  pluginSuccessRate: Record<string, number>;
  channelSuccessRate: Record<string, number>;
}

export class MetricsCollector {
  private metrics: SearchMetrics = {
    totalRequests: 0,
    successfulRequests: 0,
    failedRequests: 0,
    averageResponseTime: 0,
    cacheHitRate: 0,
    pluginSuccessRate: {},
    channelSuccessRate: {},
  };

  private responseTimes: number[] = [];
  private cacheHits = 0;
  private cacheMisses = 0;

  recordSearch(duration: number, success: boolean, cacheHit: boolean) {
    this.metrics.totalRequests++;
    if (success) this.metrics.successfulRequests++;
    else this.metrics.failedRequests++;

    this.responseTimes.push(duration);
    if (this.responseTimes.length > 100) {
      this.responseTimes.shift();
    }

    if (cacheHit) this.cacheHits++;
    else this.cacheMisses++;

    // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
    const sum = this.responseTimes.reduce((a, b) => a + b, 0);
    this.metrics.averageResponseTime = sum / this.responseTimes.length;

    // è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
    const total = this.cacheHits + this.cacheMisses;
    this.metrics.cacheHitRate = total > 0 ? (this.cacheHits / total) * 100 : 0;
  }

  recordPlugin(plugin: string, success: boolean) {
    if (!this.metrics.pluginSuccessRate[plugin]) {
      this.metrics.pluginSuccessRate[plugin] = { success: 0, total: 0 };
    }
    this.metrics.pluginSuccessRate[plugin].total++;
    if (success) this.metrics.pluginSuccessRate[plugin].success++;
  }

  recordChannel(channel: string, success: boolean) {
    if (!this.metrics.channelSuccessRate[channel]) {
      this.metrics.channelSuccessRate[channel] = { success: 0, total: 0 };
    }
    this.metrics.channelSuccessRate[channel].total++;
    if (success) this.metrics.channelSuccessRate[channel].success++;
  }

  getMetrics(): SearchMetrics {
    // è®¡ç®—æˆåŠŸç‡
    const pluginRates: Record<string, number> = {};
    for (const [name, stats] of Object.entries(this.metrics.pluginSuccessRate)) {
      pluginRates[name] = (stats.success / stats.total) * 100;
    }

    const channelRates: Record<string, number> = {};
    for (const [name, stats] of Object.entries(this.metrics.channelSuccessRate)) {
      channelRates[name] = (stats.success / stats.total) * 100;
    }

    return {
      ...this.metrics,
      pluginSuccessRate: pluginRates,
      channelSuccessRate: channelRates,
    };
  }

  reset() {
    this.metrics = {
      totalRequests: 0,
      successfulRequests: 0,
      failedRequests: 0,
      averageResponseTime: 0,
      cacheHitRate: 0,
      pluginSuccessRate: {},
      channelSuccessRate: {},
    };
    this.responseTimes = [];
    this.cacheHits = 0;
    this.cacheMisses = 0;
  }
}

// server/api/metrics.get.ts
export default defineEventHandler(async (event) => {
  const metrics = metricsCollector.getMetrics();

  return {
    code: 0,
    data: metrics,
  };
});

// server/core/services/searchService.ts
export class SearchService {
  private metrics = new MetricsCollector();

  async search(/* ... */) {
    const start = Date.now();
    const cacheKey = /* ... */;

    // æ£€æŸ¥ç¼“å­˜
    const cached = this.cache.get(cacheKey);
    if (cached.hit) {
      this.metrics.recordSearch(Date.now() - start, true, true);
      return cached.value;
    }

    try {
      const results = await this.performSearch(/* ... */);
      this.metrics.recordSearch(Date.now() - start, true, false);
      return results;
    } catch (error) {
      this.metrics.recordSearch(Date.now() - start, false, false);
      throw error;
    }
  }
}
```

**æ”¶ç›Š**:
- ç”Ÿäº§çº§ç›‘æ§
- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
- æ’ä»¶å¥åº·åº¦è¿½è¸ª

---

## ğŸš€ éƒ¨ç½²ä¼˜åŒ–

### 15. Docker ä¼˜åŒ–

**å»ºè®® Dockerfile**:
```dockerfile
# å¤šé˜¶æ®µæ„å»ºï¼šæ„å»ºé˜¶æ®µ
FROM node:20-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependencies ç”¨äºæ„å»ºï¼‰
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# è¿è¡Œé˜¶æ®µï¼ˆæœ€å°åŒ–é•œåƒï¼‰
FROM node:20-alpine AS runtime

WORKDIR /app

# ä»…å¤åˆ¶ç”Ÿäº§éœ€è¦çš„æ–‡ä»¶
COPY --from=builder /app/.output ./.output
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/data ./data

# å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆä»… better-sqlite3ï¼‰
RUN npm ci --only=production --ignore-scripts && \
    npm rebuild better-sqlite3

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /app

USER nodejs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# å¯åŠ¨å‘½ä»¤
CMD ["node", ".output/server/index.mjs"]
```

**.dockerignore**:
```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
.env.local
test/
docs/
*.md
.DS_Store
```

**æ”¶ç›Š**:
- é•œåƒä½“ç§¯å‡å°‘ 60%+
- æ„å»ºé€Ÿåº¦æå‡
- å®‰å…¨æ€§æå‡ï¼ˆé root ç”¨æˆ·ï¼‰

---

### 16. ç¯å¢ƒé…ç½®

**å»ºè®®**:
```typescript
// server/config/env.ts
import { z } from 'zod';

const envSchema = z.object({
  // æ•°æ®åº“
  DB_PATH: z.string().default('./data/hot-searches.db'),
  DB_DIR: z.string().default('./data'),

  // ç¼“å­˜
  CACHE_ENABLED: z.enum(['true', 'false']).default('true'),
  CACHE_TTL: z.string().transform(Number).default('30'),
  CACHE_MAX_SIZE: z.string().transform(Number).default('1000'),

  // æœç´¢
  DEFAULT_CONCURRENCY: z.string().transform(Number).default('4'),
  PLUGIN_TIMEOUT: z.string().transform(Number).default('5000'),

  // æ—¥å¿—
  LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info'),

  // API
  RATE_LIMIT_WINDOW: z.string().transform(Number).default('60000'),
  RATE_LIMIT_MAX: z.string().transform(Number).default('100'),

  // ç½‘ç«™
  SITE_URL: z.string().url().default('https://panhub.shenzjd.com'),
  PORT: z.string().transform(Number).default('3000'),

  // ç¯å¢ƒ
  NODE_ENV: z.enum(['development', 'production', 'test']).default('production'),
});

export const env = envSchema.parse(process.env);

// ä½¿ç”¨ç¤ºä¾‹
import { env } from '~/config/env';

const cache = new MemoryCache({
  maxSize: env.CACHE_MAX_SIZE,
  ttlMinutes: env.CACHE_TTL,
});
```

**ç¯å¢ƒæ–‡ä»¶ç¤ºä¾‹**:
```bash
# .env
# æ•°æ®åº“é…ç½®
DB_PATH=./data/hot-searches.db
DB_DIR=./data

# ç¼“å­˜é…ç½®
CACHE_ENABLED=true
CACHE_TTL=30
CACHE_MAX_SIZE=1000

# æœç´¢é…ç½®
DEFAULT_CONCURRENCY=4
PLUGIN_TIMEOUT=5000

# æ—¥å¿—é…ç½®
LOG_LEVEL=info

# API é…ç½®
RATE_LIMIT_WINDOW=60000
RATE_LIMIT_MAX=100

# ç½‘ç«™é…ç½®
SITE_URL=https://panhub.shenzjd.com
PORT=3000

# ç¯å¢ƒ
NODE_ENV=production
```

**æ”¶ç›Š**:
- é…ç½®å³ä»£ç 
- ç¯å¢ƒéš”ç¦»
- éƒ¨ç½²çµæ´»æ€§

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨é¡¹ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å†…å®Œæˆï¼‰

#### 1. æ·»åŠ è¾“å…¥éªŒè¯ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰
- **ä½ç½®**: `server/api/search.get.ts`
- **é£é™©**: æ— éªŒè¯å¯èƒ½å¯¼è‡´æ¶æ„è¾“å…¥
- **æ”¶ç›Š**: ç«‹å³æå‡å®‰å…¨æ€§

**å®æ–½æ­¥éª¤**:
```typescript
// 1. å®‰è£… zod
npm install zod

// 2. åˆ›å»ºéªŒè¯ schema
// server/core/types/search.ts
import { z } from 'zod';

export const SearchRequestSchema = z.object({
  kw: z.string().trim().min(1).max(100),
  conc: z.number().int().min(1).max(20).optional(),
  // ... å…¶ä»–å­—æ®µ
});

// 3. åœ¨ API ä¸­ä½¿ç”¨
export default defineEventHandler(async (event) => {
  const query = getQuery(event);
  const result = SearchRequestSchema.safeParse({
    kw: query.kw,
    conc: query.conc ? Number(query.conc) : undefined,
    // ...
  });

  if (!result.success) {
    return sendError(event, createError({
      statusCode: 400,
      statusMessage: 'å‚æ•°éªŒè¯å¤±è´¥',
      data: result.error.errors,
    }));
  }

  // ä½¿ç”¨ result.data ç»§ç»­å¤„ç†
});
```

---

#### 2. ç®€åŒ– MemoryCacheï¼ˆé¢„è®¡æ—¶é—´ï¼š1å°æ—¶ï¼‰
- **ä½ç½®**: `server/core/cache/memoryCache.ts`
- **é—®é¢˜**: å¤æ‚çš„ LRU å®ç°
- **æ”¶ç›Š**: ä»£ç ç®€åŒ– 60%ï¼Œæ€§èƒ½æå‡

**å®æ–½æ­¥éª¤**:
```typescript
// 1. ç®€åŒ–æ•°æ®ç»“æ„
export class MemoryCache<T = unknown> {
  private store = new Map<string, CacheRecord<T>>();
  private maxSize: number;
  private maxMemoryBytes: number;

  // 2. ç®€åŒ– get æ–¹æ³•
  get(key: string): { hit: boolean; value?: T } {
    const record = this.store.get(key);
    if (!record || record.expireAt <= Date.now()) {
      this.store.delete(key);
      return { hit: false };
    }

    // ç§»åŠ¨åˆ°æœ«å°¾ï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰
    this.store.delete(key);
    this.store.set(key, record);

    return { hit: true, value: record.value };
  }

  // 3. ç®€åŒ– set æ–¹æ³•
  set(key: string, value: T, ttlMs: number): void {
    // æ¸…ç†è¿‡æœŸ
    const now = Date.now();
    for (const [k, r] of this.store) {
      if (r.expireAt <= now) this.store.delete(k);
    }

    // å®¹é‡æ£€æŸ¥
    if (this.store.size >= this.maxSize) {
      const firstKey = this.store.keys().next().value;
      this.store.delete(firstKey);
    }

    // å†…å­˜æ£€æŸ¥
    const size = this.estimateSize(value);
    let currentMemory = this.calculateMemoryUsage();
    while (currentMemory + size > this.maxMemoryBytes && this.store.size > 0) {
      const firstKey = this.store.keys().next().value;
      const removed = this.store.get(firstKey);
      if (removed) currentMemory -= removed.size;
      this.store.delete(firstKey);
    }

    this.store.set(key, { value, expireAt: now + ttlMs, size });
  }
}
```

---

#### 3. ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆé¢„è®¡æ—¶é—´ï¼š2å°æ—¶ï¼‰
- **ä½ç½®**: åˆ›å»º `server/core/errors/` å’Œ `server/core/utils/error-handler.ts`
- **é—®é¢˜**: é”™è¯¯å¤„ç†åˆ†æ•£
- **æ”¶ç›Š**: æ›´å¥½çš„è°ƒè¯•ä½“éªŒ

**å®æ–½æ­¥éª¤**:
```typescript
// 1. åˆ›å»º AppError ç±»
// server/core/errors/app-error.ts
export class AppError extends Error { /* ... */ }

// 2. åˆ›å»ºé”™è¯¯å¤„ç†å™¨
// server/core/utils/error-handler.ts
export function handleError(error: unknown): AppError { /* ... */ }

// 3. åœ¨æ‰€æœ‰ API ä¸­ä½¿ç”¨
export default defineEventHandler(async (event) => {
  try {
    // ä¸šåŠ¡é€»è¾‘
    return { code: 0, data: result };
  } catch (error) {
    const appError = handleError(error);
    return sendError(event, createError({
      statusCode: appError.statusCode,
      statusMessage: appError.message,
      data: { code: appError.code, details: appError.details },
    }));
  }
});
```

---

#### 4. æ‹†åˆ† useSearch.tsï¼ˆé¢„è®¡æ—¶é—´ï¼š4å°æ—¶ï¼‰
- **ä½ç½®**: `composables/useSearch/`
- **é—®é¢˜**: å•ä¸€æ–‡ä»¶ 10KBï¼Œéš¾ä»¥ç»´æŠ¤
- **æ”¶ç›Š**: ä»£ç ç»„ç»‡æ¸…æ™°

**å®æ–½æ­¥éª¤**:
```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p composables/useSearch

# æ‹†åˆ†æ–‡ä»¶
# composables/useSearch/index.ts      # ä¸»å…¥å£
# composables/useSearch/state.ts      # çŠ¶æ€ç®¡ç†
# composables/useSearch/flow.ts       # æµç¨‹æ§åˆ¶
# composables/useSearch/batch.ts      # æ‰¹æ¬¡å¤„ç†
# composables/useSearch/utils.ts      # å·¥å…·å‡½æ•°
```

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬æœˆå†…å®Œæˆï¼‰

#### 5. å®ç°é€Ÿç‡é™åˆ¶ï¼ˆé¢„è®¡æ—¶é—´ï¼š3å°æ—¶ï¼‰
- **ä½ç½®**: `server/middleware/rate-limit.ts`
- **æ”¶ç›Š**: é˜²æ­¢ API æ»¥ç”¨

#### 6. æ’ä»¶ç³»ç»Ÿé‡æ„ï¼ˆé¢„è®¡æ—¶é—´ï¼š6å°æ—¶ï¼‰
- **ä½ç½®**: `server/core/plugins/manager.ts`
- **æ”¶ç›Š**: æ”¯æŒåŠ¨æ€åŠ è½½ï¼Œå‡å°‘ç¡¬ç¼–ç 

#### 7. æ·»åŠ å®Œæ•´æµ‹è¯•ï¼ˆé¢„è®¡æ—¶é—´ï¼š8å°æ—¶ï¼‰
- **ä½ç½®**: `test/unit/` å’Œ `test/integration/`
- **æ”¶ç›Š**: ä»£ç è´¨é‡ä¿è¯

#### 8. é…ç½®é›†ä¸­åŒ–ï¼ˆé¢„è®¡æ—¶é—´ï¼š2å°æ—¶ï¼‰
- **ä½ç½®**: `config/index.ts` å’Œ `config/constants.ts`
- **æ”¶ç›Š**: ç»Ÿä¸€ç®¡ç†

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆä¸‹æœˆå®Œæˆï¼‰

#### 9. ç›‘æ§æŒ‡æ ‡æ”¶é›†ï¼ˆé¢„è®¡æ—¶é—´ï¼š4å°æ—¶ï¼‰
- **ä½ç½®**: `server/core/utils/metrics.ts`
- **æ”¶ç›Š**: ç”Ÿäº§çº§è¿ç»´

#### 10. Docker ä¼˜åŒ–ï¼ˆé¢„è®¡æ—¶é—´ï¼š2å°æ—¶ï¼‰
- **ä½ç½®**: `Dockerfile` å’Œ `.dockerignore`
- **æ”¶ç›Š**: éƒ¨ç½²æ•ˆç‡

#### 11. æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆé¢„è®¡æ—¶é—´ï¼š4å°æ—¶ï¼‰
- **ä½ç½®**: `test/performance/`
- **æ”¶ç›Š**: è¯†åˆ«ç“¶é¢ˆ

#### 12. æ–‡æ¡£å®Œå–„ï¼ˆé¢„è®¡æ—¶é—´ï¼š4å°æ—¶ï¼‰
- **ä½ç½®**: `docs/` å’Œ README
- **æ”¶ç›Š**: é™ä½ä¸Šæ‰‹æˆæœ¬

---

## ğŸ’¡ å¿«é€Ÿæ”¶ç›Šä¼˜åŒ–ï¼ˆ1-2å°æ—¶ï¼‰

å¦‚æœæ—¶é—´æœ‰é™ï¼Œä»¥ä¸‹ä¼˜åŒ–èƒ½å¸¦æ¥æœ€å¤§æ”¶ç›Šï¼š

### 1. æ·»åŠ è¾“å…¥éªŒè¯ï¼ˆ30åˆ†é’Ÿï¼‰
```typescript
// ç«‹å³å®æ–½ï¼Œé˜²æ­¢æ¶æ„è¾“å…¥
// æ”¶ç›Šï¼šâ­â­â­â­â­ å®‰å…¨æ€§
```

### 2. ç®€åŒ– MemoryCacheï¼ˆ1å°æ—¶ï¼‰
```typescript
// ç§»é™¤å¤æ‚ LRUï¼Œä½¿ç”¨ Map ä¿æŒé¡ºåº
// æ”¶ç›Šï¼šâ­â­â­â­â­ å¯ç»´æŠ¤æ€§ + æ€§èƒ½
```

### 3. ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆ2å°æ—¶ï¼‰
```typescript
// åˆ›å»º AppError å’Œé”™è¯¯å¤„ç†å™¨
// æ”¶ç›Šï¼šâ­â­â­â­ è°ƒè¯•ä½“éªŒ
```

### 4. æ‹†åˆ†å¤§æ–‡ä»¶ï¼ˆ4å°æ—¶ï¼‰
```typescript
// useSearch.ts æ‹†åˆ†ä¸º 5 ä¸ªå°æ–‡ä»¶
// æ”¶ç›Šï¼šâ­â­â­â­ å¯ç»´æŠ¤æ€§
```

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Šæ€»ç»“

| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¸»è¦æ”¶ç›Š |
|--------|--------|----------|----------|
| è¾“å…¥éªŒè¯ | ğŸ”´ é«˜ | 30min | å®‰å…¨æ€§ +500% |
| ç®€åŒ–ç¼“å­˜ | ğŸ”´ é«˜ | 1h | æ€§èƒ½ +30%, ä»£ç  -60% |
| é”™è¯¯å¤„ç† | ğŸ”´ é«˜ | 2h | ç¨³å®šæ€§ +200% |
| æ‹†åˆ†æ–‡ä»¶ | ğŸ”´ é«˜ | 4h | å¯ç»´æŠ¤æ€§ +300% |
| é€Ÿç‡é™åˆ¶ | ğŸŸ¡ ä¸­ | 3h | é˜²æ»¥ç”¨ |
| æ’ä»¶é‡æ„ | ğŸŸ¡ ä¸­ | 6h | æ‰©å±•æ€§ +200% |
| æµ‹è¯•è¦†ç›– | ğŸŸ¡ ä¸­ | 8h | è´¨é‡ +400% |
| é…ç½®é›†ä¸­ | ğŸŸ¡ ä¸­ | 2h | å¯é…ç½®æ€§ +150% |
| ç›‘æ§æŒ‡æ ‡ | ğŸŸ¢ ä½ | 4h | è¿ç»´èƒ½åŠ› |
| Docker ä¼˜åŒ– | ğŸŸ¢ ä½ | 2h | éƒ¨ç½²æ•ˆç‡ |
| æ€§èƒ½æµ‹è¯• | ğŸŸ¢ ä½ | 4h | æ€§èƒ½ä¼˜åŒ– |
| æ–‡æ¡£å®Œå–„ | ğŸŸ¢ ä½ | 4h | ä¸Šæ‰‹é€Ÿåº¦ |

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€å‘¨ï¼šåŸºç¡€åŠ å›º
- âœ… è¾“å…¥éªŒè¯
- âœ… ç®€åŒ–ç¼“å­˜
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… é€Ÿç‡é™åˆ¶

### ç¬¬äºŒå‘¨ï¼šæ¶æ„ä¼˜åŒ–
- âœ… æ‹†åˆ† useSearch.ts
- âœ… æ’ä»¶ç³»ç»Ÿé‡æ„
- âœ… é…ç½®é›†ä¸­åŒ–

### ç¬¬ä¸‰å‘¨ï¼šè´¨é‡æå‡
- âœ… æ·»åŠ å•å…ƒæµ‹è¯•
- âœ… æ·»åŠ é›†æˆæµ‹è¯•
- âœ… ç±»å‹å®‰å…¨å¢å¼º

### ç¬¬å››å‘¨ï¼šç”Ÿäº§çº§ç‰¹æ€§
- âœ… ç›‘æ§æŒ‡æ ‡
- âœ… Docker ä¼˜åŒ–
- âœ… æ–‡æ¡£å®Œå–„

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœåœ¨å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹å…·ä½“æ–‡ä»¶çš„æ³¨é‡Šå’Œæ–‡æ¡£
2. è¿è¡Œæµ‹è¯•éªŒè¯ä¿®æ”¹
3. å‚è€ƒç›¸å…³å¼€æºé¡¹ç›®å®ç°
4. åˆ†æ­¥å®æ–½ï¼Œå…ˆéªŒè¯å†æ¨å¹¿

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-06
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ
